<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å…³é”®ä¿®æ”¹ï¼šç§»åŠ¨ç«¯viewportä¼˜åŒ– -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ°‘ä¿—å­¦æ€ç»´å¯¼å›¾é«˜æ¸…æŸ¥çœ‹å™¨</title>
    <style>
        /* ... ä¿æŒä½ çš„CSSæ ·å¼ä¸å˜ ... */
    </style>
</head>
<body>
    <!-- ... ä¿æŒHTMLç»“æ„ä¸å˜ ... -->

    <script>
// ========== ä½¿ç”¨æ•°å­—æ–‡ä»¶å ==========
const imageFiles = [
    "01.png", "02.png", "03.png", "04.png", "05.png",
    "06.png", "07.png", "08.png", "09.png", "10.png",
    "11.png", "12.png", "13.png", "14.png", "15.png", "16.png"
];

// ç« èŠ‚åç§°æ˜ å°„
const chapterNames = {
    "01.png": "ç¬¬ä¸€ç«  æ¦‚è¿°",
    "02.png": "ç¬¬äºŒç«  ç‰©è´¨ç”Ÿäº§æ°‘ä¿—", 
    "03.png": "ç¬¬ä¸‰ç«  ç‰©è´¨ç”Ÿæ´»æ°‘ä¿—",
    "04.png": "ç¬¬å››ç«  ç¤¾ä¼šç»„ç»‡æ°‘ä¿—",
    "05.png": "ç¬¬äº”ç«  èŠ‚æ—¥æ°‘é—´ä¹ ä¿—",
    "06.png": "ç¬¬å…­ç«  äººç”Ÿä»ªç¤¼",
    "07.png": "ç¬¬ä¸ƒç«  æ°‘ä¿—ä¿¡ä»°",
    "08.png": "ç¬¬å…«ç«  æ°‘é—´ç§‘å­¦æŠ€æœ¯",
    "09.png": "ç¬¬ä¹ç«  æ°‘é—´æ–‡å­¦ï¼ˆä¸Šï¼‰",
    "10.png": "ç¬¬åç«  æ°‘é—´æ–‡å­¦ï¼ˆä¸‹ï¼‰",
    "11.png": "ç¬¬åä¸€ç«  æ°‘é—´è¯­è¨€",
    "12.png": "ç¬¬åäºŒç«  æ°‘é—´è‰ºæœ¯",
    "13.png": "ç¬¬åä¸‰ç«  æ°‘é—´æ¸¸æˆå¨±ä¹",
    "14.png": "ç¬¬åå››ç«  ä¸­å›½æ°‘ä¿—å­¦å²ç•¥",
    "15.png": "ç¬¬åäº”ç«  å¤–å›½æ°‘ä¿—å­¦æ¦‚å†µ",
    "16.png": "ç¬¬åå…­ç«  æ°‘ä¿—å­¦ç ”ç©¶æ–¹æ³•"
};

// ========== çŠ¶æ€ç®¡ç† ==========
const state = {
    images: [],
    currentIndex: 0,
    scale: 1,
    translateX: 0,
    translateY: 0,
    isDragging: false,
    startX: 0,
    startY: 0,
    lastTouchDistance: 0,  // æ–°å¢ï¼šç”¨äºè§¦æ‘¸ç¼©æ”¾
    isLoading: false       // æ–°å¢ï¼šé˜²æ­¢é‡å¤åŠ è½½
};

// DOMå…ƒç´ 
const elements = {
    thumbnailsContainer: document.getElementById('thumbnailsContainer'),
    currentTitle: document.getElementById('currentTitle'),
    currentImage: document.getElementById('currentImage'),
    imageContainer: document.getElementById('imageContainer'),
    zoomDisplay: document.getElementById('zoomDisplay'),
    pageIndicator: document.getElementById('pageIndicator'),
    zoomInBtn: document.getElementById('zoomInBtn'),
    zoomOutBtn: document.getElementById('zoomOutBtn'),
    prevBtn: document.getElementById('prevBtn'),
    nextBtn: document.getElementById('nextBtn'),
    resetBtn: document.getElementById('resetBtn'),
    fullscreenBtn: document.getElementById('fullscreenBtn'),
    chapterCounter: document.getElementById('chapterCounter'),
    controlPanel: document.querySelector('.control-panel')
};

// ========== æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ç§»åŠ¨ç«¯å‹å¥½çš„URLæ ¼å¼ ==========
function init() {
    console.log("ğŸ§  ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆæŸ¥çœ‹å™¨åˆå§‹åŒ–...");
    
    // ä¿®å¤ï¼šä½¿ç”¨æ›´ç¨³å®šçš„GitHub URLæ ¼å¼
    state.images = imageFiles.map((filename) => {
        const chapterNum = parseInt(filename.replace('.png', ''));
        const baseName = filename.replace('.png', '');
        
        // å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨å¤šç§URLæ ¼å¼ï¼Œæé«˜å…¼å®¹æ€§
        return {
            name: chapterNames[filename] || filename,
            number: chapterNum,
            // ä¸»URLï¼šGitHub Pagesç›´æ¥è®¿é—®
            url: `https://huohuo87635.github.io/mindmap-viewer/${filename}`,
            // å¤‡ç”¨URL1ï¼šraw.githubusercontent.comï¼ˆæœ€ç¨³å®šï¼‰
            backupUrl1: `https://raw.githubusercontent.com/huohuo87635/mindmap-viewer/main/${filename}`,
            // å¤‡ç”¨URL2ï¼šGitHub raw content
            backupUrl2: `https://github.com/huohuo87635/mindmap-viewer/raw/main/${filename}`,
            // å¤‡ç”¨URL3ï¼šå¸¦blobå‚æ•°
            backupUrl3: `https://github.com/huohuo87635/mindmap-viewer/blob/main/${filename}?raw=true`,
            filename: filename
        };
    });
    
    console.log(`âœ… å…± ${state.images.length} å¼ å›¾ç‰‡ï¼Œä½¿ç”¨ç§»åŠ¨ç«¯ä¼˜åŒ–URL`);
    
    // æ›´æ–°ç« èŠ‚è®¡æ•°
    elements.chapterCounter.textContent = `å…±${state.images.length}ç« `;
    
    // ç”Ÿæˆç¼©ç•¥å›¾
    renderThumbnails();
    
    // åŠ è½½ç¬¬ä¸€å¼ å›¾ç‰‡
    if (state.images.length > 0) {
        loadImageWithRetry(0);
    }
    
    // å¯ç”¨æ§åˆ¶é¢æ¿
    elements.controlPanel.style.opacity = '1';
    elements.controlPanel.style.pointerEvents = 'auto';
    
    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    setupEventListeners();
    
    console.log("âœ… ç§»åŠ¨ç«¯ä¼˜åŒ–åˆå§‹åŒ–å®Œæˆï¼");
}

// ========== å¢å¼ºçš„å›¾ç‰‡åŠ è½½å‡½æ•°ï¼ˆæ”¯æŒé‡è¯•ï¼‰==========
async function loadImageWithRetry(index) {
    if (state.isLoading) return;
    
    state.currentIndex = index;
    const img = state.images[index];
    state.isLoading = true;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    elements.currentImage.style.display = 'none';
    const loadingText = elements.imageContainer.querySelector('div');
    if (loadingText) {
        loadingText.style.display = 'block';
        loadingText.textContent = 'åŠ è½½ä¸­...';
    }
    
    console.log(`ğŸ“± åŠ è½½: ${img.name}`);
    
    // å°è¯•å¤šä¸ªURL
    const urlsToTry = [
        img.url + '?t=' + Date.now(),  // ä¸»URL
        img.backupUrl1 + '?t=' + Date.now(),  // å¤‡ç”¨1
        img.backupUrl2 + '?t=' + Date.now(),  // å¤‡ç”¨2
        img.backupUrl3  // å¤‡ç”¨3
    ];
    
    let success = false;
    
    for (let i = 0; i < urlsToTry.length; i++) {
        try {
            console.log(`å°è¯•URL ${i+1}: ${urlsToTry[i].substring(0, 60)}...`);
            success = await loadSingleImage(img, urlsToTry[i]);
            if (success) break;
        } catch (error) {
            console.warn(`URL ${i+1} å¤±è´¥:`, error.message);
        }
    }
    
    if (!success) {
        showLoadError(img);
    }
    
    state.isLoading = false;
}

function loadSingleImage(img, url) {
    return new Promise((resolve) => {
        const tempImg = new Image();
        tempImg.crossOrigin = 'anonymous';  // é¿å…CORSé—®é¢˜
        
        const timeout = setTimeout(() => {
            tempImg.onload = tempImg.onerror = null;
            resolve(false);
        }, 10000);  // 10ç§’è¶…æ—¶
        
        tempImg.onload = function() {
            clearTimeout(timeout);
            console.log(`âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ: ${img.name} (${url.substring(0, 40)}...)`);
            
            // æ›´æ–°æ˜¾ç¤ºå›¾ç‰‡
            elements.currentImage.src = url;
            elements.currentImage.alt = img.name;
            elements.currentImage.style.display = 'block';
            elements.currentImage.style.opacity = '0';
            
            // æ·¡å…¥æ•ˆæœ
            setTimeout(() => {
                elements.currentImage.style.opacity = '1';
            }, 50);
            
            // éšè—åŠ è½½æç¤º
            const loadingText = elements.imageContainer.querySelector('div');
            if (loadingText) loadingText.style.display = 'none';
            
            // æ›´æ–°UI
            elements.currentTitle.textContent = img.name;
            updatePageIndicator();
            updateActiveThumbnail(state.currentIndex);
            resetTransform();
            
            resolve(true);
        };
        
        tempImg.onerror = function() {
            clearTimeout(timeout);
            console.warn(`âŒ å›¾ç‰‡åŠ è½½å¤±è´¥: ${url.substring(0, 40)}...`);
            resolve(false);
        };
        
        tempImg.src = url;
    });
}

function showLoadError(img) {
    console.error(`âŒ æ‰€æœ‰URLéƒ½å¤±è´¥: ${img.name}`);
    elements.currentTitle.textContent = `âŒ åŠ è½½å¤±è´¥: ${img.name}`;
    
    const loadingText = elements.imageContainer.querySelector('div');
    if (loadingText) {
        loadingText.innerHTML = `
            <div style="color: #ff6b6b; font-size: 16px; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 10px;">ğŸ˜¢</div>
                <strong>å›¾ç‰‡åŠ è½½å¤±è´¥</strong><br>
                ${img.filename}<br><br>
                <button onclick="loadImageWithRetry(${state.currentIndex})" 
                        style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    ç‚¹å‡»é‡è¯•
                </button>
            </div>
        `;
    }
}

// ========== æ¸²æŸ“ç¼©ç•¥å›¾ï¼ˆä¼˜åŒ–ç§»åŠ¨ç«¯ï¼‰==========
function renderThumbnails() {
    elements.thumbnailsContainer.innerHTML = '';
    
    // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šæ˜¾ç¤ºåŠ è½½æç¤º
    if (state.images.length === 0) {
        elements.thumbnailsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666; grid-column: 1 / -1;">
                <div style="font-size: 48px; margin-bottom: 10px;">â³</div>
                æ­£åœ¨åŠ è½½å›¾ç‰‡åˆ—è¡¨...
            </div>
        `;
        return;
    }
    
    state.images.forEach((img, index) => {
        const thumbnail = document.createElement('div');
        thumbnail.className = `thumbnail-item ${index === state.currentIndex ? 'active' : ''}`;
        thumbnail.dataset.index = index;
        
        // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šä½¿ç”¨ä½è´¨é‡å ä½å›¾
        thumbnail.innerHTML = `
            <div class="thumbnail-img-placeholder" 
                 style="width: 100%; height: 120px; background: linear-gradient(135deg, #f5f7fa, #c3cfe2); 
                        border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <span style="font-size: 24px;">ğŸ“š</span>
            </div>
            <div class="thumbnail-name">${img.name}</div>
            <div class="thumbnail-number">ç¬¬${img.number}ç« </div>
        `;
        
        // ç‚¹å‡»äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰
        thumbnail.addEventListener('click', (e) => {
            if (state.isLoading) return;
            e.preventDefault();
            loadImageWithRetry(index);
            updateActiveThumbnail(index);
            
            // ç§»åŠ¨ç«¯ç‚¹å‡»åæ»šåŠ¨åˆ°é¡¶éƒ¨
            if (window.innerWidth <= 768) {
                document.querySelector('.viewer-section').scrollIntoView({ 
                    behavior: 'smooth' 
                });
            }
        });
        
        // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
        thumbnail.addEventListener('touchstart', (e) => {
            e.preventDefault();
        }, { passive: false });
        
        elements.thumbnailsContainer.appendChild(thumbnail);
        
        // å»¶è¿ŸåŠ è½½çœŸå®ç¼©ç•¥å›¾
        setTimeout(() => {
            const placeholder = thumbnail.querySelector('.thumbnail-img-placeholder');
            if (placeholder) {
                placeholder.innerHTML = `<img class="thumbnail-img" 
                    src="${img.url}" 
                    alt="${img.name}"
                    loading="lazy"
                    style="width: 100%; height: 120px; object-fit: contain; border-radius: 8px;"
                    onerror="this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><text y=\".9em\" font-size=\"90\">ğŸ“·</text></svg>;'">`;
            }
        }, index * 100);
    });
}

// ========== ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶æ”¯æŒ ==========
function setupEventListeners() {
    // æŒ‰é’®äº‹ä»¶ï¼ˆä¿æŒåŸæœ‰ï¼‰
    elements.zoomInBtn.addEventListener('click', handleZoomIn);
    elements.zoomOutBtn.addEventListener('click', handleZoomOut);
    elements.prevBtn.addEventListener('click', handlePrev);
    elements.nextBtn.addEventListener('click', handleNext);
    elements.resetBtn.addEventListener('click', resetTransform);
    elements.fullscreenBtn.addEventListener('click', toggleFullscreen);
    
    // ç§»åŠ¨ç«¯è§¦æ‘¸æ‹–æ‹½
    setupTouchEvents();
    
    // é”®ç›˜å¿«æ·é”®
    setupKeyboardEvents();
}

function setupTouchEvents() {
    let touchStartX = 0;
    let touchStartY = 0;
    let isTouchMoving = false;
    
    // è§¦æ‘¸å¼€å§‹
    elements.imageContainer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            isTouchMoving = true;
            
            // å¦‚æœæ˜¯å¿«é€Ÿæ»‘åŠ¨ï¼ˆåˆ‡æ¢ç« èŠ‚ï¼‰
            state.touchStartTime = Date.now();
        } else if (e.touches.length === 2) {
            // åŒæŒ‡ç¼©æ”¾å¼€å§‹
            const touch1 = e.touches[0];
            const touch2 = e.touches[1];
            state.lastTouchDistance = Math.hypot(
                touch1.clientX - touch2.clientX,
                touch1.clientY - touch2.clientY
            );
            e.preventDefault();
        }
    }, { passive: false });
    
    // è§¦æ‘¸ç§»åŠ¨
    elements.imageContainer.addEventListener('touchmove', (e) => {
        if (isTouchMoving && e.touches.length === 1) {
            const touch = e.touches[0];
            const deltaX = touch.clientX - touchStartX;
            const deltaY = touch.clientY - touchStartY;
            
            // å¦‚æœæ˜¯æ‹–æ‹½ï¼ˆç§»åŠ¨è·ç¦»è¾ƒå¤§ï¼‰
            if (Math.abs(deltaX) > 10 || Math.abs(deltaY) > 10) {
                state.translateX += deltaX;
                state.translateY += deltaY;
                applyTransform();
                
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
                e.preventDefault();
            }
        } else if (e.touches.length === 2) {
            // åŒæŒ‡ç¼©æ”¾
            const touch1 = e.touches[0];
            const touch2 = e.touches[1];
            const currentDistance = Math.hypot(
                touch1.clientX - touch2.clientX,
                touch1.clientY - touch2.clientY
            );
            
            if (state.lastTouchDistance > 0) {
                const scaleFactor = currentDistance / state.lastTouchDistance;
                handleZoom(scaleFactor, 
                    (touch1.clientX + touch2.clientX) / 2,
                    (touch1.clientY + touch2.clientY) / 2
                );
            }
            
            state.lastTouchDistance = currentDistance;
            e.preventDefault();
        }
    }, { passive: false });
    
    // è§¦æ‘¸ç»“æŸ
    elements.imageContainer.addEventListener('touchend', (e) => {
        if (isTouchMoving && state.touchStartTime) {
            const touchDuration = Date.now() - state.touchStartTime;
            const touch = e.changedTouches[0];
            const deltaX = touch.clientX - touchStartX;
            
            // å¿«é€Ÿæ»‘åŠ¨åˆ‡æ¢ç« èŠ‚ï¼ˆä»…æ°´å¹³æ–¹å‘ï¼‰
            if (touchDuration < 300 && Math.abs(deltaX) > 50) {
                if (deltaX > 0) {
                    // å‘å³æ»‘åŠ¨ï¼šä¸Šä¸€ç« 
                    handlePrev();
                } else {
                    // å‘å·¦æ»‘åŠ¨ï¼šä¸‹ä¸€ç« 
                    handleNext();
                }
            }
        }
        
        isTouchMoving = false;
        state.lastTouchDistance = 0;
        state.touchStartTime = null;
    });
    
    // é˜»æ­¢ç§»åŠ¨ç«¯é»˜è®¤è¡Œä¸º
    elements.imageContainer.addEventListener('touchmove', (e) => {
        if (e.scale !== 1) {
            e.preventDefault();
        }
    }, { passive: false });
}

// ========== è¾…åŠ©å‡½æ•° ==========
function handleZoomIn() {
    state.scale = Math.min(state.scale * 1.3, 10);
    applyTransform();
}

function handleZoomOut() {
    state.scale = Math.max(state.scale * 0.7, 0.1);
    applyTransform();
}

function handlePrev() {
    const newIndex = (state.currentIndex - 1 + state.images.length) % state.images.length;
    loadImageWithRetry(newIndex);
}

function handleNext() {
    const newIndex = (state.currentIndex + 1) % state.images.length;
    loadImageWithRetry(newIndex);
}

function handleZoom(delta, clientX, clientY) {
    const rect = elements.imageContainer.getBoundingClientRect();
    const mouseX = clientX - rect.left - rect.width / 2;
    const mouseY = clientY - rect.top - rect.height / 2;
    
    const newScale = state.scale * delta;
    if (newScale < 0.1 || newScale > 10) return;
    
    // è®¡ç®—ç¼©æ”¾ä¸­å¿ƒç‚¹åç§»
    const scaleDiff = newScale - state.scale;
    state.translateX -= (mouseX * scaleDiff) / state.scale;
    state.translateY -= (mouseY * scaleDiff) / state.scale;
    
    state.scale = newScale;
    applyTransform();
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            console.warn(`å…¨å±è¯·æ±‚å¤±è´¥: ${err.message}`);
        });
    } else {
        document.exitFullscreen();
    }
}

function applyTransform() {
    elements.currentImage.style.transform = `translate(${state.translateX}px, ${state.translateY}px) scale(${state.scale})`;
    elements.zoomDisplay.textContent = `${Math.round(state.scale * 100)}%`;
}

function resetTransform() {
    state.scale = 1;
    state.translateX = 0;
    state.translateY = 0;
    applyTransform();
}

function updatePageIndicator() {
    const current = state.currentIndex + 1;
    const total = state.images.length;
    elements.pageIndicator.textContent = `${current} / ${total}`;
}

function updateActiveThumbnail(index) {
    document.querySelectorAll('.thumbnail-item').forEach((item, i) => {
        item.classList.toggle('active', i === index);
    });
}

function setupKeyboardEvents() {
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch(e.key) {
            case 'ArrowLeft': handlePrev(); break;
            case 'ArrowRight': handleNext(); break;
            case '+': case '=': handleZoomIn(); break;
            case '-': handleZoomOut(); break;
            case '0': resetTransform(); break;
            case 'f': case 'F': toggleFullscreen(); break;
        }
    });
}

// ========== å¯åŠ¨åº”ç”¨ ==========
// ç­‰å¾…DOMå®Œå…¨åŠ è½½
document.addEventListener('DOMContentLoaded', () => {
    console.log("ğŸš€ ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆæŸ¥çœ‹å™¨å¯åŠ¨");
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç§»åŠ¨è®¾å¤‡
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    console.log(`ğŸ“± è®¾å¤‡æ£€æµ‹: ${isMobile ? 'ç§»åŠ¨è®¾å¤‡' : 'æ¡Œé¢è®¾å¤‡'}`);
    
    // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ï¼Œæ·»åŠ ä¸€äº›é¢å¤–ä¼˜åŒ–
    if (isMobile) {
        // ç§»é™¤ä¸å¿…è¦çš„åŠ¨ç”»ä»¥æå‡æ€§èƒ½
        document.querySelectorAll('*').forEach(el => {
            if (el.style.transition) el.style.transition = 'none';
        });
        
        // ç¦ç”¨åŒæŒ‡ç¼©æ”¾é¡µé¢ï¼ˆé˜²æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸ºï¼‰
        document.addEventListener('touchmove', (e) => {
            if (e.scale !== 1) {
                e.preventDefault();
            }
        }, { passive: false });
    }
    
    // åˆå§‹åŒ–åº”ç”¨
    setTimeout(init, 100);
});

// çª—å£å¤§å°å˜åŒ–æ—¶é‡ç½®è§†å›¾
window.addEventListener('resize', () => {
    if (state.currentIndex >= 0) {
        resetTransform();
    }
});

// æ§åˆ¶å°æç¤º
console.log("âœ¨ ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆæ°‘ä¿—å­¦æ€ç»´å¯¼å›¾æŸ¥çœ‹å™¨");
console.log("ğŸ“š æ”¯æŒè§¦æ‘¸ã€æ‹–æ‹½ã€ç¼©æ”¾ã€å…¨å±");
console.log("ğŸ”§ ä½¿ç”¨å¤šURLé‡è¯•æœºåˆ¶æé«˜åŠ è½½æˆåŠŸç‡");
    </script>
</body>
</html>
