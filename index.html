    <script>
// ========== ä½¿ç”¨æ•°å­—æ–‡ä»¶å ==========
const imageFiles = [
    "01.png", "02.png", "03.png", "04.png", "05.png",
    "06.png", "07.png", "08.png", "09.png", "10.png",
    "11.png", "12.png", "13.png", "14.png", "15.png", "16.png"
];

// ç« èŠ‚åç§°æ˜ å°„ï¼ˆç”¨äºæ˜¾ç¤ºä¸­æ–‡æ ‡é¢˜ï¼‰
const chapterNames = {
    "01.png": "ç¬¬ä¸€ç«  æ¦‚è¿°",
    "02.png": "ç¬¬äºŒç«  ç‰©è´¨ç”Ÿäº§æ°‘ä¿—", 
    "03.png": "ç¬¬ä¸‰ç«  ç‰©è´¨ç”Ÿæ´»æ°‘ä¿—",
    "04.png": "ç¬¬å››ç«  ç¤¾ä¼šç»„ç»‡æ°‘ä¿—",
    "05.png": "ç¬¬äº”ç«  èŠ‚æ—¥æ°‘é—´ä¹ ä¿—",
    "06.png": "ç¬¬å…­ç«  äººç”Ÿä»ªç¤¼",
    "07.png": "ç¬¬ä¸ƒç«  æ°‘ä¿—ä¿¡ä»°",
    "08.png": "ç¬¬å…«ç«  æ°‘é—´ç§‘å­¦æŠ€æœ¯",
    "09.png": "ç¬¬ä¹ç«  æ°‘é—´æ–‡å­¦ï¼ˆä¸Šï¼‰",
    "10.png": "ç¬¬åç«  æ°‘é—´æ–‡å­¦ï¼ˆä¸‹ï¼‰",
    "11.png": "ç¬¬åä¸€ç«  æ°‘é—´è¯­è¨€",
    "12.png": "ç¬¬åäºŒç«  æ°‘é—´è‰ºæœ¯",
    "13.png": "ç¬¬åä¸‰ç«  æ°‘é—´æ¸¸æˆå¨±ä¹",
    "14.png": "ç¬¬åå››ç«  ä¸­å›½æ°‘ä¿—å­¦å²ç•¥",
    "15.png": "ç¬¬åäº”ç«  å¤–å›½æ°‘ä¿—å­¦æ¦‚å†µ",
    "16.png": "ç¬¬åå…­ç«  æ°‘ä¿—å­¦ç ”ç©¶æ–¹æ³•"
};

// ========== çŠ¶æ€ç®¡ç† ==========
const state = {
    images: [],
    currentIndex: 0,
    scale: 1,
    translateX: 0,
    translateY: 0,
    isDragging: false,
    startX: 0,
    startY: 0,
    isLoading: false // æ–°å¢ï¼šç”¨äºé˜²æ­¢é‡å¤åŠ è½½
};

// DOMå…ƒç´ 
const elements = {
    thumbnailsContainer: document.getElementById('thumbnailsContainer'),
    currentTitle: document.getElementById('currentTitle'),
    currentImage: document.getElementById('currentImage'),
    imageContainer: document.getElementById('imageContainer'),
    zoomDisplay: document.getElementById('zoomDisplay'),
    pageIndicator: document.getElementById('pageIndicator'),
    chapterCounter: document.getElementById('chapterCounter'),
    controlPanel: document.querySelector('.control-panel'),
    loadingText: document.querySelector('#imageContainer > div') // è·å–åŠ è½½æç¤ºæ–‡å­—
};

// ========== æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨æœ€ç¨³å®šçš„å›¾ç‰‡URL ==========
function init() {
    console.log("ğŸ§  æŸ¥çœ‹å™¨åˆå§‹åŒ– (ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆ)...");
    
    // 1. å¤„ç†å›¾ç‰‡åˆ—è¡¨ - å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨å…¬å¼€ä»“åº“çš„æ ‡å‡†Rawé“¾æ¥
    state.images = imageFiles.map((filename) => {
        const chapterNum = parseInt(filename.replace('.png', ''));
        return {
            name: chapterNames[filename] || filename,
            number: chapterNum,
            // ï¼ï¼ï¼ æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ç¨³å®šã€æ ‡å‡†çš„ raw.githubusercontent.com é“¾æ¥ ï¼ï¼ï¼
            url: `https://raw.githubusercontent.com/huohuo87635/mindmap-viewer/main/${filename}`,
            // å¤‡ç”¨URLï¼šå¯ä»¥ç•™ç©ºï¼Œæˆ–ä½¿ç”¨å…¶ä»–å¤‡ç”¨å›¾åºŠ
            backupUrl: '', // æš‚æ—¶ä¸éœ€è¦å¤‡ç”¨
            filename: filename
        };
    });
    
    console.log(`âœ… å…± ${state.images.length} å¼ å›¾ç‰‡ï¼Œä½¿ç”¨æ ‡å‡†Rawé“¾æ¥`);
    
    // 2. æ›´æ–°ç« èŠ‚è®¡æ•°
    elements.chapterCounter.textContent = `å…±${state.images.length}ç« `;
    
    // 3. ç”Ÿæˆç¼©ç•¥å›¾
    renderThumbnails();
    
    // 4. åŠ è½½ç¬¬ä¸€å¼ å›¾ç‰‡
    if (state.images.length > 0) {
        loadImage(0);
    } else {
        showError('æœªæ‰¾åˆ°å¯ç”¨çš„å›¾ç‰‡æ–‡ä»¶');
    }
    
    // 5. ç»‘å®šäº‹ä»¶
    setupEventListeners();
    
    console.log("âœ… åˆå§‹åŒ–å®Œæˆï¼");
}

// ========== æ¸²æŸ“ç¼©ç•¥å›¾ ==========
function renderThumbnails() {
    elements.thumbnailsContainer.innerHTML = '';
    
    state.images.forEach((img, index) => {
        const thumbnail = document.createElement('div');
        thumbnail.className = `thumbnail-item ${index === state.currentIndex ? 'active' : ''}`;
        thumbnail.dataset.index = index;
        
        thumbnail.innerHTML = `
            <img class="thumbnail-img" 
                 data-src="${img.url}" 
                 alt="${img.name}"
                 loading="lazy">
            <div class="thumbnail-name">${img.name}</div>
            <div class="thumbnail-number">ç¬¬${img.number}ç« </div>
        `;
        
        thumbnail.addEventListener('click', () => {
            if (state.isLoading) return; // é˜²æ­¢åŠ è½½ä¸­é‡å¤ç‚¹å‡»
            loadImage(index);
            updateActiveThumbnail(index);
        });
        
        elements.thumbnailsContainer.appendChild(thumbnail);
        
        // å»¶è¿ŸåŠ è½½ç¼©ç•¥å›¾
        setTimeout(() => {
            const imgEl = thumbnail.querySelector('.thumbnail-img');
            if (imgEl && imgEl.dataset.src) {
                imgEl.src = imgEl.dataset.src;
            }
        }, index * 100);
    });
}

// ========== æ ¸å¿ƒä¼˜åŒ–ï¼šå¢å¼ºçš„å›¾ç‰‡åŠ è½½å‡½æ•° (è§£å†³ç§»åŠ¨ç«¯é—®é¢˜) ==========
function loadImage(index) {
    if (state.isLoading) return;
    
    state.currentIndex = index;
    const img = state.images[index];
    state.isLoading = true;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    if (elements.loadingText) {
        elements.loadingText.textContent = 'åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...';
        elements.loadingText.style.display = 'block';
    }
    elements.currentImage.style.display = 'none';
    elements.currentImage.style.opacity = '0';
    
    console.log(`ğŸ“± åŠ è½½: ${img.name}`);
    
    // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶å’Œäº‹ä»¶
    if (window._imgLoadTimeout) clearTimeout(window._imgLoadTimeout);
    
    // è®¾ç½®åŠ è½½è¶…æ—¶ï¼ˆç§»åŠ¨ç«¯ç½‘ç»œä¸ç¨³å®šï¼Œè®¾ä¸º20ç§’ï¼‰
    window._imgLoadTimeout = setTimeout(() => {
        console.warn(`â° åŠ è½½è¶…æ—¶: ${img.name}`);
        if (elements.currentImage.src.includes(img.url)) {
            handleImageError(img, 'ç½‘ç»œè¶…æ—¶ï¼Œè¯·æ£€æŸ¥è¿æ¥');
        }
    }, 20000);
    
    // åˆ›å»ºæ–°çš„Imageå¯¹è±¡é¢„åŠ è½½ï¼ˆæ›´å¯é ï¼‰
    const loader = new Image();
    loader.crossOrigin = 'anonymous'; // é¿å…CORSé—®é¢˜
    
    loader.onload = function() {
        clearTimeout(window._imgLoadTimeout);
        state.isLoading = false;
        
        // å°†åŠ è½½å¥½çš„å›¾ç‰‡èµ‹ç»™æ˜¾ç¤ºå…ƒç´ 
        elements.currentImage.src = this.src;
        elements.currentImage.alt = img.name;
        elements.currentImage.style.display = 'block';
        
        // æ·¡å…¥æ•ˆæœ
        setTimeout(() => {
            elements.currentImage.style.opacity = '1';
            if (elements.loadingText) {
                elements.loadingText.style.display = 'none';
            }
        }, 50);
        
        console.log(`âœ… åŠ è½½æˆåŠŸ: ${img.name}`);
        updateUI(img);
    };
    
    loader.onerror = function() {
        clearTimeout(window._imgLoadTimeout);
        handleImageError(img, 'å›¾ç‰‡åŠ è½½å¤±è´¥');
    };
    
    // å¼€å§‹åŠ è½½ï¼ˆæ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜ï¼‰
    loader.src = img.url + '?t=' + Date.now();
}

// ========== é”™è¯¯å¤„ç† ==========
function handleImageError(img, message) {
    state.isLoading = false;
    console.error(`âŒ ${message}: ${img.name}`);
    
    if (elements.loadingText) {
        elements.loadingText.innerHTML = `âŒ ${message}<br>ç‚¹å‡»é‡è¯•`;
        elements.loadingText.style.display = 'block';
        elements.loadingText.onclick = () => loadImage(state.currentIndex);
    }
    
    elements.currentImage.style.display = 'none';
    
    // 3ç§’åè‡ªåŠ¨é‡è¯•ä¸€æ¬¡
    setTimeout(() => {
        if (state.currentIndex === state.images.indexOf(img)) {
            console.log('ğŸ”„ è‡ªåŠ¨é‡è¯•åŠ è½½...');
            loadImage(state.currentIndex);
        }
    }, 3000);
}

function showError(msg) {
    if (elements.loadingText) {
        elements.loadingText.innerHTML = `âŒ ${msg}`;
        elements.loadingText.style.display = 'block';
    }
}

// ========== æ›´æ–°ç•Œé¢ ==========
function updateUI(img) {
    elements.currentTitle.textContent = img.name;
    elements.pageIndicator.textContent = `${state.currentIndex + 1} / ${state.images.length}`;
    updateActiveThumbnail(state.currentIndex);
    resetTransform(); // åŠ è½½æ–°å›¾åé‡ç½®ç¼©æ”¾å’Œä½ç½®
}

function updateActiveThumbnail(index) {
    document.querySelectorAll('.thumbnail-item').forEach((item, i) => {
        item.classList.toggle('active', i === index);
    });
}

// ========== å›¾ç‰‡å˜æ¢ç›¸å…³ ==========
function applyTransform() {
    elements.currentImage.style.transform = 
        `translate(${state.translateX}px, ${state.translateY}px) scale(${state.scale})`;
    elements.zoomDisplay.textContent = `${Math.round(state.scale * 100)}%`;
}

function resetTransform() {
    state.scale = 1;
    state.translateX = 0;
    state.translateY = 0;
    applyTransform();
}

// ========== æ ¸å¿ƒä¼˜åŒ–ï¼šå¢å¼ºçš„äº‹ä»¶ç›‘å¬å™¨ (æ”¯æŒç§»åŠ¨ç«¯è§¦æ‘¸) ==========
function setupEventListeners() {
    // æ§åˆ¶æŒ‰é’®
    document.getElementById('zoomInBtn').addEventListener('click', () => {
        state.scale = Math.min(state.scale * 1.3, 10);
        applyTransform();
    });
    
    document.getElementById('zoomOutBtn').addEventListener('click', () => {
        state.scale = Math.max(state.scale * 0.7, 0.1);
        applyTransform();
    });
    
    document.getElementById('prevBtn').addEventListener('click', () => {
        const newIndex = (state.currentIndex - 1 + state.images.length) % state.images.length;
        loadImage(newIndex);
    });
    
    document.getElementById('nextBtn').addEventListener('click', () => {
        const newIndex = (state.currentIndex + 1) % state.images.length;
        loadImage(newIndex);
    });
    
    document.getElementById('resetBtn').addEventListener('click', resetTransform);
    
    document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
    
    // é¼ æ ‡/è§¦æ‘¸æ‹–æ‹½
    setupDragEvents();
    
    // ç¼©æ”¾ï¼ˆé¼ æ ‡æ»šè½®å’Œè§¦æ‘¸æ‰‹åŠ¿ï¼‰
    setupZoomEvents();
    
    // é”®ç›˜å¿«æ·é”®ï¼ˆä»…æ¡Œé¢ç«¯ï¼‰
    setupKeyboardEvents();
    
    // å¯ç”¨æ§åˆ¶é¢æ¿
    elements.controlPanel.style.opacity = '1';
    elements.controlPanel.style.pointerEvents = 'auto';
}

function setupDragEvents() {
    let isTouchDragging = false;
    
    // é¼ æ ‡äº‹ä»¶
    elements.imageContainer.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        startDrag(e.clientX, e.clientY);
        elements.imageContainer.classList.add('grabbing');
        e.preventDefault();
    });
    
    // è§¦æ‘¸äº‹ä»¶ - ç§»åŠ¨ç«¯å…³é”®ï¼
    elements.imageContainer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
            const touch = e.touches[0];
            startDrag(touch.clientX, touch.clientY);
            isTouchDragging = true;
            e.preventDefault();
        }
    });
    
    function startDrag(clientX, clientY) {
        state.isDragging = true;
        state.startX = clientX - state.translateX;
        state.startY = clientY - state.translateY;
    }
    
    // ç§»åŠ¨/æ‹–æ‹½
    document.addEventListener('mousemove', (e) => {
        if (!state.isDragging) return;
        state.translateX = e.clientX - state.startX;
        state.translateY = e.clientY - state.startY;
        applyTransform();
    });
    
    document.addEventListener('touchmove', (e) => {
        if (!state.isDragging || !isTouchDragging || e.touches.length !== 1) return;
        const touch = e.touches[0];
        state.translateX = touch.clientX - state.startX;
        state.translateY = touch.clientY - state.startY;
        applyTransform();
        e.preventDefault();
    });
    
    // ç»“æŸæ‹–æ‹½
    const endDrag = () => {
        state.isDragging = false;
        isTouchDragging = false;
        elements.imageContainer.classList.remove('grabbing');
    };
    
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);
    document.addEventListener('touchcancel', endDrag);
}

function setupZoomEvents() {
    // é¼ æ ‡æ»šè½®
    elements.imageContainer.addEventListener('wheel', (e) => {
        e.preventDefault();
        handleZoom(e.deltaY > 0 ? 0.9 : 1.1, e.clientX, e.clientY);
    });
    
    // ç§»åŠ¨ç«¯åŒæŒ‡ç¼©æ”¾ï¼ˆåŸºç¡€å®ç°ï¼‰
    let initialDistance = 0;
    elements.imageContainer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            initialDistance = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            e.preventDefault();
        }
    });
    
    elements.imageContainer.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2 && initialDistance > 0) {
            const currentDistance = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            const scaleFactor = currentDistance / initialDistance;
            const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
            const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
            
            handleZoom(scaleFactor, centerX, centerY);
            initialDistance = currentDistance;
            e.preventDefault();
        }
    });
    
    elements.imageContainer.addEventListener('touchend', (e) => {
        if (e.touches.length < 2) {
            initialDistance = 0;
        }
    });
}

function handleZoom(delta, clientX, clientY) {
    const rect = elements.imageContainer.getBoundingClientRect();
    const mouseX = clientX - rect.left - rect.width / 2;
    const mouseY = clientY - rect.top - rect.height / 2;
    
    const newScale = state.scale * delta;
    if (
